# 安全考虑

<cite>
**本文档中引用的文件**  
- [SECURITY.md](file://SECURITY.md)
- [init.go](file://init.go)
- [nonce.go](file://nonce.go)
- [streamclient.go](file://streamclient.go)
- [streamserver.go](file://streamserver.go)
- [packetclient.go](file://packetclient.go)
- [packetserver.go](file://packetserver.go)
- [websocket.go](file://websocket.go)
- [protocol/brook-server-protocol.md](file://protocol/brook-server-protocol.md)
- [protocol/brook-wsserver-protocol.md](file://protocol/brook-wsserver-protocol.md)
- [protocol/brook-link-protocol.md](file://protocol/brook-link-protocol.md)
- [cli/brook/main.go](file://cli/brook/main.go)
</cite>

## 目录
1. [简介](#简介)
2. [核心安全机制](#核心安全机制)
3. [认证与密码管理](#认证与密码管理)
4. [防重放攻击措施](#防重放攻击措施)
5. [安全配置指南](#安全配置指南)
6. [漏洞报告流程](#漏洞报告流程)

## 简介

brook 是一个跨平台的可编程网络工具，提供多种网络代理功能。本安全文档系统化地介绍了 brook 的安全机制和最佳实践，详细解释其核心安全特性，包括 AES-GCM 加密、HKDF 密钥派生和时间戳验证等。文档还说明了认证机制、密码管理策略和防重放攻击措施，并基于 SECURITY.md 提供了漏洞报告流程，指导用户进行安全配置。

**Section sources**
- [README.md](file://README.md)

## 核心安全机制

brook 的安全架构基于现代密码学原理，采用 AES-GCM 加密模式和 HKDF 密钥派生函数来确保通信的机密性和完整性。协议设计中包含了时间戳验证机制，有效防止重放攻击。

### AES-GCM 加密

brook 使用 AES-GCM（Advanced Encryption Standard in Galois/Counter Mode）作为其主要加密模式。AES-GCM 是一种认证加密模式，同时提供数据加密和完整性验证。在 brook 中，AES-GCM 使用 32 字节的密钥，确保了高强度的加密保护。

加密过程涉及以下步骤：
1. 使用 HKDF 密钥派生函数从用户密码生成 32 字节的 AES 密钥
2. 使用随机生成的 12 字节 Nonce 作为 GCM 模式的初始化向量
3. 对数据进行加密并生成认证标签

这种加密模式确保了即使攻击者截获了加密数据，也无法解密或篡改数据而不被发现。

**Section sources**
- [protocol/brook-server-protocol.md](file://protocol/brook-server-protocol.md)
- [streamclient.go](file://streamclient.go#L103-L143)
- [streamserver.go](file://streamserver.go#L47-L98)

### HKDF 密钥派生

brook 使用 HKDF（HMAC-based Key Derivation Function）从用户密码派生加密密钥。HKDF 是一种基于 HMAC 的密钥派生函数，能够从弱密钥材料生成强加密密钥。

在 brook 中，密钥派生过程如下：
```
KEY = HKDF_SHA256(Password, Nonce, Info)
```

其中：
- Password：用户定义的密码
- Nonce：12 字节的随机数
- Info：固定信息字节 [0x62, 0x72, 0x6f, 0x6f, 0x6b]（"brook" 的 ASCII 值）

这种密钥派生方法确保了即使使用相同的密码，每次连接也会生成不同的加密密钥，增强了安全性。

**Section sources**
- [init.go](file://init.go#L17-L18)
- [protocol/brook-server-protocol.md](file://protocol/brook-server-protocol.md#L25-L28)
- [streamclient.go](file://streamclient.go#L111-L117)

### 时间戳验证

为了防止重放攻击，brook 在通信协议中集成了时间戳验证机制。客户端在发送第一个数据片段时，会包含一个 Unix 时间戳。服务器收到请求后，会验证该时间戳是否在有效时间窗口内（通常为 60 秒）。

对于 TCP 连接，时间戳位于第一个加密片段中：
```
Unix Timestamp + DST Address
```

服务器验证时间戳的有效性，如果时间戳过期（超过 60 秒），则拒绝连接。这种机制有效防止了攻击者捕获并重放旧的通信数据。

**Section sources**
- [simplestreamserver.go](file://simplestreamserver.go#L65-L69)
- [streamserver.go](file://streamserver.go#L85-L90)
- [protocol/brook-server-protocol.md](file://protocol/brook-server-protocol.md#L48-L51)

## 认证与密码管理

brook 的认证机制基于共享密钥模式，通过密码验证确保只有授权用户可以访问服务。系统提供了灵活的密码管理策略和安全配置选项。

### 认证机制

brook 使用基于密码的认证机制。客户端和服务器通过共享密码建立安全通信。在连接建立过程中，客户端和服务器使用 HKDF 从共享密码派生出对称加密密钥。

对于 TCP 流连接，服务器首先验证密码：
```go
if bytes.Compare(password, b[:32]) != 0 {
    return nil, errors.New("Password is wrong")
}
```

这种认证方式确保了只有知道正确密码的客户端才能与服务器建立连接。

**Section sources**
- [simplestreamserver.go](file://simplestreamserver.go#L51-L55)
- [streamserver.go](file://streamserver.go#L59-L64)

### 密码管理策略

为了确保安全性，brook 推荐以下密码管理策略：

1. **密码强度**：使用至少 12 个字符的复杂密码，包含大小写字母、数字和特殊字符
2. **定期更换**：建议定期更换密码，特别是在怀疑密码可能泄露时
3. **唯一性**：避免在多个服务中重复使用相同的密码
4. **安全存储**：不要将密码明文存储在配置文件中，使用环境变量或安全的密钥管理服务

在 CLI 配置中，可以通过 `--password` 参数指定密码：
```
brook server --listen :9999 --password your_strong_password
```

**Section sources**
- [cli/brook/main.go](file://cli/brook/main.go#L313-L316)
- [cli/brook/main.go](file://cli/brook/main.go#L544-L547)

## 防重放攻击措施

brook 实施了多层次的防重放攻击措施，结合时间戳验证、Nonce 管理和连接状态控制，有效防止各种形式的重放攻击。

### Nonce 管理

brook 使用 12 字节的随机 Nonce 作为加密的初始化向量。Nonce 的管理遵循以下规则：

1. **随机生成**：每次连接时，客户端和服务器都生成随机的 12 字节 Nonce
2. **递增机制**：对于长连接，Nonce 会按照 Little Endian 64 位无符号整数的方式递增
3. **单次使用**：每个 Nonce 只能用于一次加密操作

在代码实现中，Nonce 的递增通过 `NextNonce` 函数完成：
```go
func NextNonce(b []byte) {
    i := binary.LittleEndian.Uint64(b[:8])
    i += 1
    binary.LittleEndian.PutUint64(b[:8], i)
}
```

这种 Nonce 管理机制确保了即使在同一连接中，每个加密操作也使用不同的初始化向量，防止了重放攻击。

**Section sources**
- [nonce.go](file://nonce.go#L19-L23)
- [streamclient.go](file://streamclient.go#L202-L206)
- [streamserver.go](file://streamserver.go#L211-L215)

### 连接状态验证

brook 通过验证连接状态来防止重放攻击。服务器会检查客户端发送的时间戳，确保其在有效时间窗口内。如果时间戳过期，连接将被立即终止。

此外，对于 UDP 连接，每个数据包都包含时间戳，服务器会对每个数据包进行独立验证。这种机制有效防止了攻击者捕获并重放单个 UDP 数据包。

**Section sources**
- [simplestreamserver.go](file://simplestreamserver.go#L65-L69)
- [packetclient.go](file://packetclient.go#L114-L115)

## 安全配置指南

为了最大化 brook 的安全性，建议遵循以下安全配置最佳实践。

### 安全参数配置

在配置 brook 服务时，应使用以下安全参数：

```bash
brook server \
  --listen :9999 \
  --password your_strong_password \
  --tcpTimeout 30 \
  --udpTimeout 60 \
  --log /var/log/brook.log
```

关键安全参数说明：
- `--password`：设置强密码
- `--tcpTimeout`：设置合理的 TCP 超时时间，防止资源耗尽
- `--udpTimeout`：设置 UDP 连接超时，防止 UDP 泛洪攻击
- `--log`：启用日志记录，便于安全审计

### HKDF Info 自定义

为了增强安全性，可以自定义 HKDF Info 参数。这可以通过 CLI 参数或 brook link 实现：

```bash
brook server \
  --listen :9999 \
  --password hello \
  --clientHKDFInfo custom_client_info \
  --serverHKDFInfo custom_server_info
```

或者在 brook link 中：
```
brook://server?password=hello&server=1.2.3.4%3A9999&clientHKDFInfo=custom&serverHKDFInfo=custom
```

自定义 HKDF Info 可以增加攻击者逆向工程的难度。

**Section sources**
- [cli/brook/main.go](file://cli/brook/main.go#L130-L138)
- [cli/brook/main.go](file://cli/brook/main.go#L486-L491)

### WebSocket 安全配置

当使用 WebSocket 协议时，建议启用 TLS 加密：

```bash
brook wssserver \
  --domainaddress yourdomain.com:443 \
  --password hello \
  --cert /path/to/cert.pem \
  --certkey /path/to/certkey.pem
```

使用 wssserver 命令可以自动配置 HTTPS 和 WebSocket 安全连接，提供端到端的加密保护。

**Section sources**
- [cli/brook/main.go](file://cli/brook/main.go#L784-L798)

## 漏洞报告流程

brook 项目重视安全性，欢迎安全研究人员报告发现的漏洞。以下是官方的漏洞报告流程。

### 漏洞报告方式

如果发现 brook 的安全漏洞，请通过电子邮件报告给开发团队：

- **报告邮箱**：cloud@txthinking.com
- **建议内容**：在报告中直接包含概念验证（POC），这将有助于快速验证和修复问题

所有报告的安全漏洞都将被及时处理。开发团队承诺对所有漏洞报告进行认真评估，并在合理的时间内提供修复方案。

### 披露政策

建议采用负责任的披露方式：
1. 发现漏洞后，首先通过上述邮箱通知开发团队
2. 给予开发团队合理的修复时间（通常为 30-90 天）
3. 在官方发布修复版本后，再公开披露漏洞细节

这种披露方式可以确保用户有足够时间升级到安全版本，同时保护广大用户的安全。

**Section sources**
- [SECURITY.md](file://SECURITY.md#L1-L8)