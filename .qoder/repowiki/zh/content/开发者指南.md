# 开发者指南

<cite>
**本文档中引用的文件**  
- [main.go](file://cli/brook/main.go)
- [go.mod](file://go.mod)
- [.travis.yml](file://.travis.yml)
- [brooklink.go](file://brooklink.go)
- [link.go](file://link.go)
- [init.go](file://init.go)
- [README.md](file://README.md)
- [programmable/readme.md](file://programmable/readme.md)
- [plugins/readme.md](file://plugins/readme.md)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [依赖管理](#依赖管理)
3. [构建与测试流程](#构建与测试流程)
4. [代码风格与规范](#代码风格与规范)
5. [贡献流程](#贡献流程)
6. [插件系统](#插件系统)
7. [可编程脚本](#可编程脚本)
8. [CI/CD 配置](#cicd-配置)

## 项目结构

该项目是一个跨平台的可编程网络工具，采用Go语言开发。项目结构清晰，主要分为以下几个部分：

- `cli/brook/`：命令行接口主程序
- `core/`：核心功能模块
- `docs/`：文档和静态资源
- `limits/`：系统限制相关功能
- `ping/`：ping相关配置
- `plugins/`：插件系统，包含多个功能插件
- `programmable/`：可编程脚本模块
- `protocol/`：协议文档

主程序入口位于`cli/brook/main.go`，使用`urfave/cli/v2`库构建命令行界面，支持多种网络服务模式。

**Section sources**
- [main.go](file://cli/brook/main.go#L1-L800)
- [README.md](file://README.md#L1-L44)

## 依赖管理

项目使用Go Modules进行依赖管理，`go.mod`文件定义了项目的所有依赖。

```go
module github.com/txthinking/brook

go 1.22

toolchain go1.23.0

require (
	github.com/gorilla/mux v1.8.1
	github.com/gorilla/websocket v1.5.1
	github.com/krolaw/dhcp4 v0.0.0-20190909130307-a50d88189771
	github.com/miekg/dns v1.1.57
	github.com/patrickmn/go-cache v2.1.0+incompatible
	github.com/phuslu/iploc v1.0.20240501
	github.com/prometheus/client_golang v1.19.1
	github.com/quic-go/quic-go v0.48.2
	github.com/refraction-networking/utls v1.5.4
	github.com/tdewolff/minify v2.3.6+incompatible
	github.com/txthinking/runnergroup v0.0.0-20230325130830-408dc5853f86
	github.com/txthinking/socks5 v0.0.0-20230325130024-4230056ae301
	github.com/txthinking/x v0.0.0-20240301021728-6f68aba84c87
	github.com/urfave/cli/v2 v2.25.7
	github.com/urfave/negroni v1.0.0
	golang.org/x/crypto v0.26.0
	golang.org/x/net v0.28.0
)
```

项目依赖主要包括：
- `gorilla/mux` 和 `gorilla/websocket`：HTTP路由和WebSocket支持
- `miekg/dns`：DNS解析功能
- `quic-go/quic-go`：QUIC协议支持
- `urfave/cli/v2`：命令行界面
- `prometheus/client_golang`：监控指标收集

**Section sources**
- [go.mod](file://go.mod#L1-L55)

## 构建与测试流程

项目使用标准的Go构建和测试流程。构建过程简单直接：

```bash
cd cli/brook && go build .
```

测试流程包括：
1. 运行单元测试：`go test -v .`
2. 构建CLI工具：`cd cli/brook && go build .`

项目包含多种服务模式，可以通过命令行参数启动不同的服务：
- `brook server`：启动基础服务器
- `brook wsserver`：启动WebSocket服务器
- `brook wssserver`：启动WebSocket安全服务器
- `brook quicserver`：启动QUIC服务器
- `brook client`：启动客户端

**Section sources**
- [main.go](file://cli/brook/main.go#L51-L800)
- [.travis.yml](file://.travis.yml#L1-L11)

## 代码风格与规范

项目遵循Go语言的标准代码风格，主要特点包括：

1. **包命名**：使用简洁明了的包名，如`brook`、`plugins`等
2. **函数命名**：采用驼峰命名法，如`NewBrookLink`、`ListenAndServe`
3. **错误处理**：统一使用Go的错误返回机制
4. **注释规范**：所有公共函数和结构体都有详细的注释说明

代码结构清晰，每个功能模块都有明确的职责划分。例如，`brooklink.go`文件专门处理Brook链接的创建和管理，`link.go`文件处理链接的解析和生成。

**Section sources**
- [brooklink.go](file://brooklink.go#L1-L375)
- [link.go](file://link.go#L1-L38)

## 贡献流程

贡献者可以通过以下步骤参与项目开发：

1. **环境准备**：确保安装了Go 1.22或更高版本
2. **代码克隆**：`git clone https://github.com/txthinking/brook.git`
3. **依赖安装**：`go mod tidy`
4. **代码修改**：在本地进行功能开发或bug修复
5. **测试验证**：运行`go test -v .`确保所有测试通过
6. **提交代码**：创建Pull Request

项目采用MIT许可证，贡献者在提交代码时即同意将代码贡献给项目。

**Section sources**
- [OPENSOURCELICENSES](file://OPENSOURCELICENSES#L320-L865)
- [README.md](file://README.md#L1-L44)

## 插件系统

项目提供了灵活的插件系统，位于`plugins/`目录下。每个插件都是一个独立的Go包，通过导入主程序来扩展功能。

现有插件包括：
- `block`：域名和IP地址过滤
- `dialwithdns`：自定义DNS解析
- `dialwithip`：指定IP地址拨号
- `dialwithnic`：指定网络接口拨号
- `logger`：日志记录
- `pprof`：性能分析
- `prometheus`：监控指标暴露
- `socks5dial`：SOCKS5代理拨号
- `thedns`：自定义DNS服务器

插件通过在`main.go`中导入并调用`TouchBrook()`方法来激活。

**Section sources**
- [plugins/readme.md](file://plugins/readme.md#L1-L2)
- [main.go](file://cli/brook/main.go#L37-L45)

## 可编程脚本

`programmable/`目录包含可编程脚本模块，允许用户通过Tengo脚本语言自定义网络行为。脚本可以用于DNS服务器、普通服务器、客户端等不同场景。

用户可以通过提交JSON配置到`gallery.json`文件来分享自己的脚本。脚本类型包括：
- `dnsserver`：DNS服务器脚本
- `server`：服务器脚本
- `module`：GUI客户端模块
- `client`：客户端脚本

**Section sources**
- [programmable/readme.md](file://programmable/readme.md#L1-L20)

## CI/CD 配置

项目使用Travis CI进行持续集成，配置文件`.travis.yml`定义了构建和测试流程。

```yaml
language: go
sudo: false
os:
  - linux
  - osx
  - windows
go:
  - "1.16"
script:
    - go test -v .
    - cd cli/brook && go get -t -v . && go build .
```

CI流程包括：
1. 在Linux、macOS和Windows三个平台上运行测试
2. 使用Go 1.16版本进行构建
3. 执行单元测试
4. 构建CLI工具

项目还配置了GitHub Actions用于文档的自动部署，当master分支更新时，会自动将文档部署到GitHub Pages。

**Section sources**
- [.travis.yml](file://.travis.yml#L1-L11)
- [CLAUDE.md](file://CLAUDE.md#L188-L193)