# 安装与部署

<cite>
**本文档中引用的文件**  
- [main.go](file://cli/brook/main.go)
- [README.md](file://README.md)
- [go.mod](file://go.mod)
- [.travis.yml](file://.travis.yml)
- [dhcpserver_linux.go](file://dhcpserver_linux.go)
- [dhcpserver_notlinux.go](file://dhcpserver_notlinux.go)
- [logger_unix.go](file://plugins/logger/logger_unix.go)
- [logger_windows.go](file://plugins/logger/logger_windows.go)
- [OPENSOURCELICENSES](file://OPENSOURCELICENSES)
</cite>

## 目录
1. [简介](#简介)
2. [预编译二进制文件安装](#预编译二进制文件安装)
3. [源码编译安装](#源码编译安装)
4. [容器化部署](#容器化部署)
5. [平台特定注意事项](#平台特定注意事项)
6. [CI/CD自动化构建](#cicd自动化构建)
7. [验证安装](#验证安装)
8. [常见问题与解决方案](#常见问题与解决方案)
9. [最佳实践](#最佳实践)

## 简介

Brook 是一个跨平台的可编程网络工具，支持多种部署模式，包括服务器、客户端、WebSocket 服务器等。本指南详细说明了在不同平台上安装和部署 Brook 的完整流程，涵盖从预编译二进制文件安装、源码编译到容器化部署的各个方面。

**Section sources**
- [README.md](file://README.md#L1-L44)

## 预编译二进制文件安装

### Linux 系统

在 Linux 系统上，可以通过 nami 包管理器安装 Brook：

```bash
bash <(curl https://bash.ooo/nami.sh)
nami install brook
```

或者直接下载预编译的二进制文件：

```bash
wget https://github.com/txthinking/brook/releases/latest/download/Brook.bin
chmod +x Brook.bin
sudo mv Brook.bin /usr/local/bin/brook
```

### Windows 系统

Windows 用户可以从 GitHub 发布页面下载 MSIX 安装包：

```powershell
Invoke-WebRequest -Uri "https://github.com/txthinking/brook/releases/latest/download/Brook.msix" -OutFile "Brook.msix"
```

然后通过 Microsoft Store 或 PowerShell 安装该包。

### macOS 系统

macOS 用户可以通过 App Store 安装 Brook，或从 GitHub 发布页面下载。

### OpenWrt 系统

对于 OpenWrt 设备，可以使用专门的安装指南进行部署。

**Section sources**
- [README.md](file://README.md#L10-L33)

## 源码编译安装

### 环境依赖

Brook 使用 Go 语言编写，需要 Go 1.22 或更高版本。项目依赖通过 go.mod 文件管理：

```go
module github.com/txthinking/brook

go 1.22

toolchain go1.23.0

require (
    github.com/gorilla/mux v1.8.1
    github.com/gorilla/websocket v1.5.1
    github.com/krolaw/dhcp4 v0.0.0-20190909130307-a50d88189771
    github.com/miekg/dns v1.1.57
    github.com/patrickmn/go-cache v2.1.0+incompatible
    github.com/phuslu/iploc v1.0.20240501
    github.com/prometheus/client_golang v1.19.1
    github.com/quic-go/quic-go v0.48.2
    github.com/refraction-networking/utls v1.5.4
    github.com/tdewolff/minify v2.3.6+incompatible
    github.com/txthinking/runnergroup v0.0.0-20230325130830-408dc5853f86
    github.com/txthinking/socks5 v0.0.0-20230325130024-4230056ae301
    github.com/txthinking/x v0.0.0-20240301021728-6f68aba84c87
    github.com/urfave/cli/v2 v2.25.7
    github.com/urfave/negroni v1.0.0
    golang.org/x/crypto v0.26.0
    golang.org/x/net v0.28.0
)
```

### 编译步骤

1. 克隆代码仓库：
```bash
git clone https://github.com/txthinking/brook.git
cd brook
```

2. 编译 CLI 工具：
```bash
cd cli/brook
go build .
```

3. 将生成的二进制文件移动到系统路径：
```bash
sudo mv brook /usr/local/bin/
```

**Section sources**
- [go.mod](file://go.mod#L1-L55)
- [main.go](file://cli/brook/main.go#L1-L800)

## 容器化部署

虽然项目中没有提供 Dockerfile，但可以根据以下步骤创建容器镜像：

```dockerfile
FROM golang:1.23-alpine AS builder
WORKDIR /app
COPY . .
RUN cd cli/brook && go build -o brook

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/cli/brook/brook .
CMD ["./brook"]
```

构建和运行容器：
```bash
docker build -t brook .
docker run -d -p 9999:9999 brook server -l :9999 -p hello
```

## 平台特定注意事项

### Linux 上的 DHCP 服务

Brook 在 Linux 系统上实现了原生的 DHCP 服务器功能，需要特殊的权限：

```go
func DHCPListen(iface string) (net.PacketConn, error) {
    if iface == "" {
        return net.ListenPacket("udp4", ":67")
    }
    return conn.NewUDP4BoundListener(iface, ":67")
}
```

**权限要求**：需要 `CAP_SYS_RESOURCE` 权限才能绑定到特权端口（如 67）。

### 日志重置功能

Linux 和 Windows 系统在日志处理上有不同的实现：

```go
// Unix 系统支持 SIGUSR1 信号重置日志
func (p *Logger) WatchReset() {
    for {
        sigs := make(chan os.Signal, 1)
        signal.Notify(sigs, syscall.SIGUSR1)
        <-sigs
        if err := p.Reset(); err != nil {
            log.Println(err)
        }
    }
}
```

```go
// Windows 系统不支持信号重置
func (p *Logger) WatchReset() {
}
```

**Section sources**
- [dhcpserver_linux.go](file://dhcpserver_linux.go#L1-L29)
- [dhcpserver_notlinux.go](file://dhcpserver_notlinux.go#L1-L26)
- [logger_unix.go](file://plugins/logger/logger_unix.go#L1-L22)
- [logger_windows.go](file://plugins/logger/logger_windows.go#L1-L5)

## CI/CD自动化构建

项目使用 Travis CI 进行持续集成：

```yaml
language: go
sudo: false
os:
  - linux
  - osx
  - windows
go:
  - "1.16"
script:
    - go test -v .
    - cd cli/brook && go get -t -v . && go build .
```

**构建流程**：
1. 在 Linux、macOS 和 Windows 上测试
2. 运行单元测试
3. 构建 CLI 工具

**Section sources**
- [.travis.yml](file://.travis.yml#L1-L12)

## 验证安装

安装完成后，可以通过以下命令验证 Brook 是否正常工作：

```bash
# 启动服务器
brook server -l :9999 -p hello

# 在另一终端测试连接
echo "test" | nc localhost 9999
```

如果能够成功建立连接并传输数据，则安装成功。

## 常见问题与解决方案

### 权限问题

**问题**：在 Linux 上启动 DHCP 服务器时权限不足
**解决方案**：使用 `sudo` 或设置 `CAP_SYS_RESOURCE` 能力：
```bash
sudo setcap cap_net_bind_service=+ep /usr/local/bin/brook
```

### 端口占用

**问题**：端口已被其他进程占用
**解决方案**：使用 `netstat` 或 `lsof` 查找并终止占用进程，或选择其他端口。

### 依赖缺失

**问题**：编译时缺少依赖包
**解决方案**：确保 Go 环境配置正确，并运行 `go mod download` 下载所有依赖。

## 最佳实践

1. **安全配置**：使用强密码，避免在公共网络上暴露管理接口
2. **日志管理**：定期轮转日志文件，避免磁盘空间耗尽
3. **监控集成**：利用 Prometheus 插件进行性能监控
4. **更新策略**：定期更新到最新版本以获取安全补丁
5. **备份配置**：重要配置文件应定期备份

**Section sources**
- [OPENSOURCELICENSES](file://OPENSOURCELICENSES#L97-L683)